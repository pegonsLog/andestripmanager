<div class="dia-form-container">
    <mat-card class="form-card">
        <mat-card-header>
            <mat-card-title>
                <mat-icon>{{ isEditMode ? 'edit' : 'add' }}</mat-icon>
                {{ isEditMode ? 'Editar Dia' : 'Novo Dia' }}
            </mat-card-title>
            <mat-card-subtitle>
                {{ isEditMode ? 'Edite as informações do dia da viagem' : 'Adicione um novo dia à sua viagem' }}
            </mat-card-subtitle>
        </mat-card-header>

        <!-- Loading spinner -->
        <div class="loading-container" *ngIf="isLoading$ | async">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Carregando dados...</p>
        </div>

        <!-- Formulário -->
        <form [formGroup]="diaForm" (ngSubmit)="onSalvar()" *ngIf="(isLoading$ | async) === false">
            <mat-card-content>
                <!-- Seletor de Dias Disponíveis (apenas no modo de criação) -->
                <div class="form-row" *ngIf="!isEditMode && diasDisponiveis.length > 0">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Selecione um dia disponível do período da viagem</mat-label>
                        <mat-select formControlName="dataDisponivel">
                            <mat-option *ngFor="let dia of diasDisponiveis" [value]="dia">
                                {{ formatarDataSeletor(dia) }}
                            </mat-option>
                        </mat-select>
                        <mat-icon matSuffix>event_available</mat-icon>
                        <mat-hint>Selecione uma data ou use o calendário abaixo</mat-hint>
                    </mat-form-field>
                </div>

                <!-- Aviso se não houver dias disponíveis -->
                <div class="alert-container" *ngIf="!isEditMode && diasDisponiveis.length === 0 && viagemAtual">
                    <mat-icon class="alert-icon">warning</mat-icon>
                    <div class="alert-content">
                        <p><strong>Atenção:</strong> Todos os dias do período da viagem já foram cadastrados.</p>
                        <p>Período: {{ viagemAtual.dataInicio | date:'dd/MM/yyyy' }} até {{ viagemAtual.dataFim | date:'dd/MM/yyyy' }}</p>
                    </div>
                </div>

                <!-- Linha 1: Data e Número do Dia -->
                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Data</mat-label>
                        <input matInput [matDatepicker]="datePicker" formControlName="data" required>
                        <mat-datepicker-toggle matIconSuffix [for]="datePicker"></mat-datepicker-toggle>
                        <mat-datepicker #datePicker></mat-datepicker>
                        <mat-error>{{ getErrorMessage('data') }}</mat-error>
                        <mat-hint *ngIf="!isEditMode">Ou selecione acima um dia disponível</mat-hint>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Dia Nº</mat-label>
                        <input matInput type="number" formControlName="numeroDia" min="1" required>
                        <mat-error>{{ getErrorMessage('numeroDia') }}</mat-error>
                    </mat-form-field>
                </div>

                <!-- Linha 2: Origem e Destino -->
                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Origem</mat-label>
                        <input matInput formControlName="origem" placeholder="Cidade de origem" required>
                        <mat-icon matSuffix>place</mat-icon>
                        <mat-error>{{ getErrorMessage('origem') }}</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Destino</mat-label>
                        <input matInput formControlName="destino" placeholder="Cidade de destino" required>
                        <mat-icon matSuffix>flag</mat-icon>
                        <mat-error>{{ getErrorMessage('destino') }}</mat-error>
                    </mat-form-field>
                </div>

                <!-- Linha 3: Distância e Tipo de Estrada -->
                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Distância Planejada (km)</mat-label>
                        <input matInput type="number" formControlName="distanciaPlanejada" min="0.1" step="0.1"
                            (change)="onDistanciaChange()" required>
                        <mat-icon matSuffix>route</mat-icon>
                        <mat-error>{{ getErrorMessage('distanciaPlanejada') }}</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Tipo de Estrada</mat-label>
                        <mat-select formControlName="tipoEstrada" (selectionChange)="onDistanciaChange()">
                            <mat-option *ngFor="let tipo of tiposEstrada" [value]="tipo.value">
                                {{ tipo.label }}
                            </mat-option>
                        </mat-select>
                        <mat-icon matSuffix>road</mat-icon>
                    </mat-form-field>
                </div>

                <!-- Linha 4: Horários -->
                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Hora de Partida (Planejada)</mat-label>
                        <input matInput type="time" formControlName="horaPartidaPlanejada">
                        <mat-icon matSuffix>schedule</mat-icon>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Hora de Chegada (Planejada)</mat-label>
                        <input matInput type="time" formControlName="horaChegadaPlanejada">
                        <mat-icon matSuffix>flag</mat-icon>
                    </mat-form-field>
                </div>

                <!-- Tempo Estimado (calculado automaticamente) -->
                <div class="tempo-estimado-container" *ngIf="diaForm.get('tempoEstimado')?.value > 0">
                    <mat-icon>timer</mat-icon>
                    <div class="tempo-info">
                        <span class="tempo-label">Tempo Estimado de Viagem</span>
                        <span class="tempo-valor">{{ formatarTempo(diaForm.get('tempoEstimado')?.value) }}</span>
                    </div>
                </div>

                <!-- Observações -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Observações</mat-label>
                    <textarea matInput formControlName="observacoes" rows="3"
                        placeholder="Observações sobre o dia (opcional)">
          </textarea>
                    <mat-icon matSuffix>note</mat-icon>
                </mat-form-field>

                <!-- Seção de Pontos da Rota (Waypoints) -->
                <div class="pontos-rota-section">
                    <div class="section-header">
                        <h3>
                            <mat-icon>route</mat-icon>
                            Pontos da Rota (Waypoints)
                        </h3>
                        <button mat-raised-button color="accent" type="button" (click)="adicionarPontoRota()">
                            <mat-icon>add_location</mat-icon>
                            Adicionar Ponto
                        </button>
                    </div>

                    <div class="pontos-info" *ngIf="pontosRota.length === 0">
                        <mat-icon>info</mat-icon>
                        <p>Adicione pontos intermediários para que o Google Maps calcule a rota passando por esses locais. Isso é útil quando a viagem real desvia do trajeto padrão sugerido.</p>
                    </div>

                    <div class="pontos-lista" formArrayName="pontosRota">
                        <div class="ponto-item" *ngFor="let ponto of pontosRota.controls; let i = index" [formGroupName]="i">
                            <div class="ponto-header">
                                <div class="ponto-numero">
                                    <mat-icon>{{ getTipoPontoIcon(ponto.get('tipo')?.value) }}</mat-icon>
                                    <span>Ponto {{ i + 1 }}</span>
                                </div>
                                <div class="ponto-acoes">
                                    <button mat-icon-button type="button" 
                                        [disabled]="i === 0"
                                        (click)="moverPontoParaCima(i)"
                                        matTooltip="Mover para cima">
                                        <mat-icon>arrow_upward</mat-icon>
                                    </button>
                                    <button mat-icon-button type="button"
                                        [disabled]="i === pontosRota.length - 1"
                                        (click)="moverPontoParaBaixo(i)"
                                        matTooltip="Mover para baixo">
                                        <mat-icon>arrow_downward</mat-icon>
                                    </button>
                                    <button mat-icon-button type="button" color="warn"
                                        (click)="removerPontoRota(i)"
                                        matTooltip="Remover ponto">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </div>
                            </div>

                            <div class="ponto-campos">
                                <div class="form-row">
                                    <mat-form-field appearance="outline" class="form-field-large">
                                        <mat-label>Nome/Localização</mat-label>
                                        <input matInput formControlName="nome" 
                                            placeholder="Ex: Posto BR km 120, Cidade X">
                                        <mat-icon matSuffix>place</mat-icon>
                                        <mat-error *ngIf="ponto.get('nome')?.hasError('required')">
                                            Nome é obrigatório
                                        </mat-error>
                                        <mat-error *ngIf="ponto.get('nome')?.hasError('minlength')">
                                            Mínimo 2 caracteres
                                        </mat-error>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" class="form-field-small">
                                        <mat-label>Tipo</mat-label>
                                        <mat-select formControlName="tipo">
                                            <mat-option *ngFor="let tipo of tiposPontoRota" [value]="tipo.value">
                                                <mat-icon>{{ tipo.icon }}</mat-icon>
                                                {{ tipo.label }}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>

                                <div class="form-row">
                                    <mat-form-field appearance="outline" class="form-field">
                                        <mat-label>Latitude</mat-label>
                                        <input matInput type="number" formControlName="latitude" 
                                            step="0.000001" placeholder="-23.550520">
                                        <mat-error *ngIf="ponto.get('latitude')?.hasError('required')">
                                            Latitude é obrigatória
                                        </mat-error>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" class="form-field">
                                        <mat-label>Longitude</mat-label>
                                        <input matInput type="number" formControlName="longitude" 
                                            step="0.000001" placeholder="-46.633308">
                                        <mat-error *ngIf="ponto.get('longitude')?.hasError('required')">
                                            Longitude é obrigatória
                                        </mat-error>
                                    </mat-form-field>

                                    <button mat-raised-button type="button" 
                                        (click)="buscarCoordenadasPonto(i)"
                                        class="btn-buscar-coords">
                                        <mat-icon>search</mat-icon>
                                        Buscar Coords
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações adicionais -->
                <div class="info-container">
                    <mat-icon class="info-icon">info</mat-icon>
                    <div class="info-content">
                        <p><strong>Dicas:</strong></p>
                        <ul>
                            <li>O tempo estimado é calculado automaticamente baseado na distância e tipo de estrada</li>
                            <li>As datas devem seguir uma sequência lógica entre os dias</li>
                            <li>Você pode ajustar os horários depois durante a viagem</li>
                            <li><strong>Waypoints:</strong> Use pontos de passagem para rotas que desviam do trajeto padrão</li>
                        </ul>
                    </div>
                </div>
            </mat-card-content>

            <!-- Ações -->
            <mat-card-actions align="end">
                <button mat-button type="button" (click)="onCancelar()" [disabled]="isSaving$ | async">
                    <mat-icon>cancel</mat-icon>
                    Cancelar
                </button>

                <button mat-raised-button color="primary" type="submit"
                    [disabled]="diaForm.invalid || (isSaving$ | async)">
                    <mat-spinner diameter="20" *ngIf="isSaving$ | async"></mat-spinner>
                    <mat-icon *ngIf="(isSaving$ | async) === false">{{ isEditMode ? 'save' : 'add' }}</mat-icon>
                    {{ (isSaving$ | async) ? 'Salvando...' : (isEditMode ? 'Salvar' : 'Criar Dia') }}
                </button>
            </mat-card-actions>
        </form>
    </mat-card>
</div>