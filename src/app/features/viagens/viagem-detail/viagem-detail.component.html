<!-- Loading Spinner -->
<div *ngIf="isLoading()" class="loading-container mat-typography" style="font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Carregando dados da viagem...</p>
</div>

<!-- Conteúdo Principal -->
<div *ngIf="!isLoading() && viagem()" class="viagem-detail-container mat-typography" style="font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;">

    <!-- Cabeçalho da Viagem -->
    <mat-card class="header-card">
        <mat-card-header>
            <div mat-card-avatar class="avatar-icon">
                <mat-icon [color]="getCorStatus(viagem()!.status)">{{ getIconeStatus(viagem()!.status) }}</mat-icon>
            </div>

            <mat-card-title>{{ viagem()!.nome }}</mat-card-title>

            <mat-card-subtitle>
                <div class="subtitle-info">
                    <span>{{ viagem()!.origem }} → {{ viagem()!.destino }}</span>
                    <mat-chip [color]="getCorStatus(viagem()!.status)">
                        {{ getTextoStatus(viagem()!.status) }}
                    </mat-chip>
                </div>
            </mat-card-subtitle>

            <!-- Ações do Cabeçalho -->
            <div class="header-actions">
                <button mat-icon-button (click)="onVoltar()" matTooltip="Voltar para lista">
                    <mat-icon>arrow_back</mat-icon>
                </button>

                <button mat-icon-button [matMenuTriggerFor]="actionsMenu" matTooltip="Mais ações">
                    <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #actionsMenu="matMenu">
                    <button mat-menu-item (click)="onEditar()" [disabled]="!podeEditar()">
                        <mat-icon>edit</mat-icon>
                        <span>Editar Viagem</span>
                    </button>

                    <button mat-menu-item (click)="onDuplicar()">
                        <mat-icon>content_copy</mat-icon>
                        <span>Duplicar Viagem</span>
                    </button>

                    <mat-divider></mat-divider>

                    <button mat-menu-item (click)="onAtualizarStatus(StatusViagem.EM_ANDAMENTO)"
                        [disabled]="!podeIniciar()">
                        <mat-icon>play_arrow</mat-icon>
                        <span>Iniciar Viagem</span>
                    </button>

                    <button mat-menu-item (click)="onAtualizarStatus(StatusViagem.FINALIZADA)"
                        [disabled]="!podeFinalizar()">
                        <mat-icon>check_circle</mat-icon>
                        <span>Finalizar Viagem</span>
                    </button>

                    <button mat-menu-item (click)="onAtualizarStatus(StatusViagem.CANCELADA)"
                        [disabled]="viagem()!.status === StatusViagem.FINALIZADA || viagem()!.status === StatusViagem.CANCELADA">
                        <mat-icon>cancel</mat-icon>
                        <span>Cancelar Viagem</span>
                    </button>

                    <mat-divider></mat-divider>

                    <button mat-menu-item (click)="onExcluir()" class="delete-action">
                        <mat-icon>delete</mat-icon>
                        <span>Excluir Viagem</span>
                    </button>
                </mat-menu>
            </div>
        </mat-card-header>

        <!-- Informações Resumidas -->
        <mat-card-content>
            <div class="info-grid">
                <div class="info-item">
                    <mat-icon>date_range</mat-icon>
                    <div class="info-content">
                        <span class="info-label">Período</span>
                        <span class="info-value">
                            {{ viagem()!.dataInicio | date:'dd/MM/yyyy' }} - {{ viagem()!.dataFim | date:'dd/MM/yyyy' }}
                        </span>
                    </div>
                </div>

                <div class="info-item">
                    <mat-icon>schedule</mat-icon>
                    <div class="info-content">
                        <span class="info-label">Duração</span>
                        <span class="info-value">{{ calcularDuracao(viagem()!) }} dias</span>
                    </div>
                </div>

                <div class="info-item" *ngIf="viagem()!.distanciaTotal">
                    <mat-icon>straighten</mat-icon>
                    <div class="info-content">
                        <span class="info-label">Distância</span>
                        <span class="info-value">{{ formatarDistancia(viagem()!.distanciaTotal!) }}</span>
                    </div>
                </div>

                <div class="info-item" *ngIf="viagem()!.custoTotal">
                    <mat-icon>attach_money</mat-icon>
                    <div class="info-content">
                        <span class="info-label">Custo Total</span>
                        <span class="info-value">{{ formatarMoeda(viagem()!.custoTotal!) }}</span>
                    </div>
                </div>
            </div>

            <!-- Descrição -->
            <div *ngIf="viagem()!.descricao" class="description">
                <h4>Descrição</h4>
                <p>{{ viagem()!.descricao }}</p>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Modo de Edição -->
    <mat-card *ngIf="isEditMode()" class="edit-card">
        <mat-card-header>
            <mat-card-title>Editar Viagem</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <app-viagem-form [viagem]="viagem()!" [navegarAoSalvar]="false" (viagemSalva)="onViagemSalva($event)" (cancelar)="onCancelarEdicao()">
            </app-viagem-form>
        </mat-card-content>
    </mat-card>

    <!-- Abas de Conteúdo -->
    <mat-card *ngIf="!isEditMode()" class="tabs-card">
        <mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedTabChange)="onTabChange($event.index)"
            animationDuration="300ms">

            <!-- Aba Resumo -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">info</mat-icon>
                    Resumo
                </ng-template>

                <div class="tab-content">
                    <div class="resumo-container">

                        <!-- Estatísticas Gerais -->
                        <div class="stats-section">
                            <h3>Estatísticas da Viagem</h3>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <mat-icon>calendar_today</mat-icon>
                                    <div class="stat-info">
                                        <span class="stat-value">{{ calcularDuracao(viagem()!) }}</span>
                                        <span class="stat-label">Dias</span>
                                    </div>
                                </div>

                                <div class="stat-card" *ngIf="estatisticas().distanciaTotal > 0">
                                    <mat-icon>straighten</mat-icon>
                                    <div class="stat-info">
                                        <span class="stat-value">{{ estatisticas().distanciaTotal }}</span>
                                        <span class="stat-label">km</span>
                                    </div>
                                </div>

                                <div class="stat-card" *ngIf="estatisticas().custoTotal > 0">
                                    <mat-icon>attach_money</mat-icon>
                                    <div class="stat-info">
                                        <span class="stat-value">{{ formatarMoeda(estatisticas().custoTotal) }}</span>
                                        <span class="stat-label">Custo Total</span>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <mat-icon>hotel</mat-icon>
                                    <div class="stat-info">
                                        <span class="stat-value">{{ estatisticas().totalHospedagens }}</span>
                                        <span class="stat-label">Hospedagens</span>
                                    </div>
                                </div>

                                <div class="stat-card">
                                    <mat-icon>place</mat-icon>
                                    <div class="stat-info">
                                        <span class="stat-value">{{ estatisticas().totalParadas }}</span>
                                        <span class="stat-label">Paradas</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Observações -->
                        <div class="observacoes-section" *ngIf="viagem()!.observacoes">
                            <h3>Observações</h3>
                            <div class="observacoes-content">
                                <p>{{ viagem()!.observacoes }}</p>
                            </div>
                        </div>

                        <!-- Ações Rápidas -->
                        <div class="quick-actions">
                            <h3>Ações Rápidas</h3>
                            <div class="actions-grid">
                                <button mat-raised-button class="btn-text-primary" (click)="selectedTabIndex.set(1)">
                                    <mat-icon>calendar_today</mat-icon>
                                    Gerenciar Dias
                                </button>

                                <button mat-raised-button class="btn-text-accent" (click)="selectedTabIndex.set(2)">
                                    <mat-icon>place</mat-icon>
                                    Adicionar Paradas
                                </button>

                                <button mat-raised-button class="btn-text-warn" (click)="selectedTabIndex.set(4)">
                                    <mat-icon>attach_money</mat-icon>
                                    Controlar Custos
                                </button>

                                <button mat-raised-button class="btn-text-primary" (click)="selectedTabIndex.set(7)">
                                    <mat-icon>book</mat-icon>
                                    Diário de Bordo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </mat-tab>

            <!-- Aba Dias -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">calendar_today</mat-icon>
                    Dias
                </ng-template>

                <div class="tab-content">
                    <div *ngIf="diasViagem().length === 0" class="placeholder-content">
                        <mat-icon class="placeholder-icon">calendar_today</mat-icon>
                        <h3>Planejamento de Dias</h3>
                        <p>Organize cada dia da sua viagem com rotas, distâncias e tempo estimado.</p>
                        <button mat-raised-button color="primary" (click)="onAdicionarDia()">
                            <mat-icon>add</mat-icon>
                            Adicionar Dia
                        </button>
                    </div>

                    <div *ngIf="diasViagem().length > 0" class="content-list">
                        <div class="list-header">
                            <h3>Dias da Viagem ({{ diasViagem().length }})</h3>
                            <button mat-raised-button color="primary" (click)="onAdicionarDia()">
                                <mat-icon>add</mat-icon>
                                Adicionar Dia
                            </button>
                        </div>

                        <div class="dias-timeline">
                            <app-dia-viagem-card
                                *ngFor="let dia of diasViagem(); trackBy: trackByFn"
                                [dia]="dia"
                                (editar)="onEditarDia($event)"
                                (visualizar)="onVisualizarDia($event)"
                                (remover)="onRemoverDia($event)">
                            </app-dia-viagem-card>
                        </div>
                    </div>
                </div>
            </mat-tab>

            <!-- Aba Paradas -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">place</mat-icon>
                    Paradas
                </ng-template>

                <div class="tab-content">
                    <div *ngIf="paradas().length === 0" class="placeholder-content">
                        <mat-icon class="placeholder-icon">place</mat-icon>
                        <h3>Paradas da Viagem</h3>
                        <p>Registre abastecimentos, refeições e pontos de interesse.</p>
                        <button mat-raised-button color="primary" (click)="onAdicionarParada()">
                            <mat-icon>add</mat-icon>
                            Adicionar Parada
                        </button>
                    </div>

                    <div *ngIf="paradas().length > 0" class="content-list">
                        <div class="list-header">
                            <h3>Paradas ({{ paradas().length }})</h3>
                            <button mat-raised-button color="primary" (click)="onAdicionarParada()">
                                <mat-icon>add</mat-icon>
                                Adicionar Parada
                            </button>
                        </div>

                        <div class="paradas-list">
                            <app-parada-card
                                *ngFor="let p of paradas(); trackBy: trackByFn"
                                [parada]="p"
                                [diaLabel]="getDiaLabelParada(p)"
                                (visualizar)="onVisualizarParada($event)"
                                (editar)="onEditarParada($event)"
                                (excluir)="onRemoverParada($event)">
                            </app-parada-card>
                        </div>
                    </div>
                </div>
            </mat-tab>

            <!-- Aba Hospedagens -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">hotel</mat-icon>
                    Hospedagens
                </ng-template>

                <div class="tab-content">
                    <div *ngIf="hospedagens().length === 0" class="placeholder-content">
                        <mat-icon class="placeholder-icon">hotel</mat-icon>
                        <h3>Hospedagens</h3>
                        <p>Gerencie reservas, custos e avaliações das hospedagens.</p>
                        <button mat-raised-button color="primary" (click)="onAdicionarHospedagem()">
                            <mat-icon>add</mat-icon>
                            Adicionar Hospedagem
                        </button>
                    </div>

                    <div *ngIf="hospedagens().length > 0" class="content-list">
                        <div class="list-header">
                            <h3>Hospedagens ({{ hospedagens().length }})</h3>
                            <button mat-raised-button color="primary" (click)="onAdicionarHospedagem()">
                                <mat-icon>add</mat-icon>
                                Adicionar Hospedagem
                            </button>
                        </div>

                        <div class="hospedagens-list">
                            <app-hospedagem-card
                                *ngFor="let h of hospedagens(); trackBy: trackByFn"
                                [hospedagem]="h"
                                (visualizar)="onVisualizarHospedagem($event)"
                                (editar)="onEditarHospedagem($event)"
                                (excluir)="onRemoverHospedagem($event)">
                            </app-hospedagem-card>
                        </div>
                    </div>
                </div>
            </mat-tab>

            <!-- Aba Custos -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">attach_money</mat-icon>
                    Custos
                </ng-template>

                <div class="tab-content">
                    <div *ngIf="custos().length === 0" class="placeholder-content">
                        <mat-icon class="placeholder-icon">attach_money</mat-icon>
                        <h3>Controle de Custos</h3>
                        <p>Acompanhe todos os gastos da viagem por categoria.</p>
                        <button mat-raised-button color="primary" (click)="onAdicionarCusto()">
                            <mat-icon>add</mat-icon>
                            Adicionar Custo
                        </button>
                    </div>

                    <div *ngIf="custos().length > 0" class="content-list">
                        <div class="list-header">
                            <div class="header-left">
                                <h3>Custos ({{ custos().length }})</h3>
                                <span class="total-custo">Total: {{ formatarMoeda(estatisticas().custoTotal) }}</span>
                            </div>
                            <button mat-raised-button color="primary" (click)="onAdicionarCusto()">
                                <mat-icon>add</mat-icon>
                                Adicionar Custo
                            </button>
                        </div>

                        <div class="custos-list">
                            <app-custo-card
                                *ngFor="let c of custos(); trackBy: trackByFn"
                                [custo]="c"
                                (editar)="onEditarCusto($event)"
                                (excluir)="onRemoverCusto($event)">
                            </app-custo-card>
                        </div>
                    </div>
                </div>
            </mat-tab>

            <!-- Aba Clima -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">wb_sunny</mat-icon>
                    Clima
                </ng-template>

                <div class="tab-content">
                    <app-clima-viagem [viagemId]="viagem()!.id!"></app-clima-viagem>
                </div>
            </mat-tab>

            <!-- Aba Manutenção -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">build</mat-icon>
                    Manutenção
                </ng-template>

                <div class="tab-content">
                    <div *ngIf="manutencoes().length === 0" class="placeholder-content">
                        <mat-icon class="placeholder-icon">build</mat-icon>
                        <h3>Controle de Manutenção</h3>
                        <p>Registre manutenções preventivas e corretivas da motocicleta.</p>
                        <button mat-raised-button color="primary" (click)="onRegistrarManutencao()">
                            <mat-icon>add</mat-icon>
                            Registrar Manutenção
                        </button>
                    </div>

                    <div *ngIf="manutencoes().length > 0" class="content-list">
                        <div class="list-header">
                            <h3>Manutenções ({{ manutencoes().length }})</h3>
                            <button mat-raised-button color="primary" (click)="onRegistrarManutencao()">
                                <mat-icon>add</mat-icon>
                                Registrar Manutenção
                            </button>
                        </div>

                        <div class="manutencoes-list">
                            <app-manutencao-card
                                *ngFor="let manutencao of manutencoes(); trackBy: trackByFn"
                                [manutencao]="manutencao"
                                [podeEditar]="podeEditar()"
                                (visualizar)="onVisualizarManutencao($event)"
                                (editar)="onEditarManutencao($event)"
                                (excluir)="onRemoverManutencao($event)">
                            </app-manutencao-card>
                        </div>
                    </div>
                </div>
            </mat-tab>

            <!-- Aba Diário -->
            <mat-tab>
                <ng-template mat-tab-label>
                    <mat-icon class="tab-icon">book</mat-icon>
                    Diário
                </ng-template>

                <div class="tab-content">
                    <div *ngIf="entradasDiario().length === 0" class="placeholder-content">
                        <mat-icon class="placeholder-icon">book</mat-icon>
                        <h3>Diário de Bordo</h3>
                        <p>Documente suas experiências, fotos e memórias da viagem.</p>
                        <button mat-raised-button color="primary" (click)="onNovaEntradaDiario()">
                            <mat-icon>add</mat-icon>
                            Nova Entrada
                        </button>
                    </div>

                    <div *ngIf="entradasDiario().length > 0" class="content-list">
                        <!-- Cabeçalho com busca integrada -->
                        <div class="diario-header">
                            <div class="header-top">
                                <div class="header-info">
                                    <h3>Entradas do Diário</h3>
                                    <span class="badge-count">{{ entradasDiarioFiltradas().length }}</span>
                                </div>
                                <button mat-raised-button color="primary" (click)="onNovaEntradaDiario()">
                                    <mat-icon>add</mat-icon>
                                    Nova Entrada
                                </button>
                            </div>

                            <!-- Campo de busca -->
                            <div class="search-container">
                                <mat-form-field appearance="outline" class="search-field">
                                    <mat-icon matIconPrefix>search</mat-icon>
                                    <input matInput 
                                        placeholder="Buscar no diário"
                                        [(ngModel)]="filtroDiarioTexto"
                                        (input)="filtrarEntradasDiario()">
                                    <button mat-icon-button 
                                        matIconSuffix
                                        *ngIf="filtroDiarioTexto"
                                        (click)="limparFiltroDiario()"
                                        matTooltip="Limpar busca">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                    <mat-hint>Busque por título, conteúdo ou tags</mat-hint>
                                </mat-form-field>
                            </div>
                        </div>

                        <div class="diario-list">
                            <app-diario-entrada-card
                                *ngFor="let entrada of entradasDiarioFiltradas(); trackBy: trackByFn"
                                [entrada]="entrada"
                                [podeEditar]="podeEditar()"
                                (visualizar)="onVisualizarEntradaDiario($event)"
                                (editar)="onEditarEntradaDiario($event)"
                                (excluir)="onRemoverEntradaDiario($event)">
                            </app-diario-entrada-card>
                        </div>

                        <div *ngIf="entradasDiarioFiltradas().length === 0 && filtroDiarioTexto" class="no-results">
                            <mat-icon>search_off</mat-icon>
                            <p>Nenhuma entrada encontrada com o termo "{{ filtroDiarioTexto }}"</p>
                            <button mat-button (click)="limparFiltroDiario()">Limpar busca</button>
                        </div>
                    </div>
                </div>
            </mat-tab>

        </mat-tab-group>
    </mat-card>
</div>

<!-- Estado de Erro -->
<div *ngIf="!isLoading() && !viagem()" class="error-container mat-typography" style="font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <h2>Viagem não encontrada</h2>
    <p>A viagem solicitada não foi encontrada ou você não tem permissão para visualizá-la.</p>
    <button mat-raised-button color="primary" (click)="onVoltar()">
        <mat-icon>arrow_back</mat-icon>
        Voltar para Lista
    </button>
</div>